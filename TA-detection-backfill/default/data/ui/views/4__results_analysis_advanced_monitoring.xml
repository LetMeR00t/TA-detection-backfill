<form version="1.1">
  <label>4. üîç Results analysis (Advanced monitoring)</label>
  <description>This dashboard is used to analyze results between and original job and its healthcheck job</description>
  <fieldset submitButton="false">
    <input type="text" token="uid">
      <label>Healthcheck UID</label>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>SID: Original job</title>
      <single>
        <search>
          <progress>
            <unset token="sid_origin"></unset>
          </progress>
          <done>
            <set token="sid_origin">$result.job_sid$</set>
          </done>
          <query>`get_detection_backfill_reports` healthcheck_uid=$uid$
| rename "job.type" as job_type, "job.sid" as job_sid
| where job_type=="orig_job"
| table job_sid</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="height">50</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <title>SID: Healthcheck job</title>
      <single>
        <search>
          <progress>
            <unset token="sid_healthcheck"></unset>
          </progress>
          <done>
            <set token="sid_healthcheck">$result.job_sid$</set>
          </done>
          <query>`get_detection_backfill_reports` healthcheck_uid=$uid$
| rename "job.type" as job_type, "job.sid" as job_sid
| where job_type=="healthcheck_job"
| table job_sid</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="height">50</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>Signature check</title>
      <single>
        <search>
          <query>`get_detection_backfill_events` healthcheck_uid=$uid$
| rename "job.type" as job_type, "job.sid" as job_sid
| eventstats values(result_hash) as result_hash by job_sid
| eval results_hash = if(mvcount(result_hash)&gt;0,sha256(mvjoin(result_hash,",")),null()), results_sha256_origin = if(job_type=="orig_job",results_hash,null()), results_sha256_healthcheck = if(job_type=="healthcheck_job",results_hash,null())
| where type=="result"
| stats values(results_hash) as results_hash, values(job_sid) as nb_jobs
| eval nb_jobs = mvcount(nb_jobs)
| eval text = case(nb_jobs==1 AND mvcount(results_hash)==1,"Not all results data are available for comparison",mvcount(results_hash)==0,"Advanced monitoring is not enabled or not yet executed",nb_jobs==2 AND mvcount(results_hash)==1,"‚úÖ Results are the same",1==1,"‚ùå Results are different") 
| table text</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>üîç Original job results details</title>
      <table>
        <title>1Ô∏è‚É£ This is the results for the original job</title>
        <search>
          <query>`get_detection_backfill_results` healthcheck_uid=$uid$ "job.sid"=$sid_origin$
| table result.*
| rename result.* as *</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
    <panel>
      <title>üîç Healthcheck job results details executed</title>
      <table>
        <title>2Ô∏è‚É£ This is the results for the healthcheck job</title>
        <search>
          <query>`get_detection_backfill_results` healthcheck_uid=$uid$ "job.sid"=$sid_healthcheck$
| table result.*
| rename result.* as *</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>üî• Results different between the two jobs</title>
      <table>
        <title>This indicates the results that aren't present in both jobs but only in one of them</title>
        <search>
          <query>`get_detection_backfill_results` healthcheck_uid=$uid$
| rename "job.sid" as job_sid
| eventstats values(job_sid) as job_sid by healthcheck_uid
| eventstats count as nb_result_same_hash by healthcheck_uid, result_hash
| eventstats list(nb_result_same_hash) as nb_result_same_hash, dc(nb_result_same_hash) as dc_nb_result_same_hash by result_hash
| where mvcount(job_sid)!=2 OR (mvcount(nb_result_same_hash)&lt;2 AND dc_nb_result_same_hash==1)
| table result.*
| rename result.* as *</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">100</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="sid">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>
</form>