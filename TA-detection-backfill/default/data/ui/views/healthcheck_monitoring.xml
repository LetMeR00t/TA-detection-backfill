
        <dashboard version="2" theme="light" hiddenElements="{&quot;hideEdit&quot;:false,&quot;hideOpenInSearch&quot;:false,&quot;hideExport&quot;:false}">
            <label>3. 📊 Healthcheck monitoring</label>
            <description>This dashboard is used to track the healthcheck jobs results performed on the monitored savedsearch</description>
            <definition><![CDATA[{"visualizations":{"viz_3iNEmCMl":{"type":"splunk.singlevalue","title":"Earliest job time","description":"This is indicated the earliest job time found in the checked jobs for the given period","dataSources":{"primary":"ds_06bIo68c"},"options":{"majorValue":"> sparklineValues | lastPoint()","trendValue":"> sparklineValues | delta(-2)","sparklineValues":"> primary | seriesByName('earliest_time_readable')"}},"viz_55L9hk6F":{"type":"splunk.singlevalue","title":"Latest job time","description":"This is indicated the latest job time found in the checked jobs for the given period","dataSources":{"primary":"ds_06bIo68c"},"options":{"majorValue":"> sparklineValues | lastPoint()","trendValue":"> sparklineValues | delta(-2)","sparklineValues":"> primary | seriesByName('latest_time_readable')"}},"viz_IVegbHIE":{"type":"splunk.table","options":{"count":50,"columnFormat":{"Status":{"data":"> table | seriesByName(\"Status\") | formatByType(StatusColumnFormatEditorConfig)","rowColors":"> table | seriesByName('Status') | pick(StatusRowColorsEditorConfig)","rowBackgroundColors":"> table | seriesByName(\"Status\") | matchValue(StatusRowBackgroundColorsEditorConfig)"}},"showInternalFields":false},"dataSources":{"primary":"ds_EYAbil72"},"context":{"StatusColumnFormatEditorConfig":{"string":{"unitPosition":"after"}},"StatusRowColorsEditorConfig":["#3c444d"],"StatusRowBackgroundColorsEditorConfig":[{"match":"No healthcheck job found","value":"#f4baa9"},{"match":"Found healthcheck job result","value":"#a1d59c"},{"match":"Healthcheck job in progress","value":"#eee8ce"},{"match":"Healthcheck job information incomplete (selected timerange isn't sufficient)","value":"#E3E1E2"}]},"eventHandlers":[{"type":"drilldown.linkToDashboard","options":{"app":"TA-detection-backfill","dashboard":"4__results_analysis_advanced_monitoring","newTab":true,"tokens":[{"token":"uid","value":"row.UID.value"}]}}],"title":"Detailed executions"},"viz_ANhOREID":{"type":"splunk.pie","options":{"labelDisplay":"valuesAndPercentage","seriesColorsByField":{"No healthcheck job found":"#F4BAA9","Found healthcheck job result":"#A1D59C"}},"dataSources":{"primary":"ds_zE81BpRn"},"title":"Healthcheck status on the given period","description":"This is showing a statistic about all the identified jobs and their relative (or not) healthcheck job status"},"viz_Orj3SgqP":{"type":"splunk.pie","options":{"labelDisplay":"valuesAndPercentage","seriesColorsByField":{"Success ✅":"#A1D59C","Warning ⚠️":"#FFD442","Healthcheck job not executed ❔":"#F4BAA9"}},"dataSources":{"primary":"ds_yfm30hQt"},"title":"Scan count - Analysis results","description":"This is showing a statistic on the healthcheck result regarding the number of events that were scanned"},"viz_GSSCZghc":{"type":"splunk.pie","options":{"labelDisplay":"valuesAndPercentage","seriesColorsByField":{"Success ✅":"#A1D59C","Warning ⚠️":"#FFD442","Healthcheck job not executed ❔":"#F4BAA9"}},"dataSources":{"primary":"ds_Q8TOTrez_ds_yfm30hQt"},"title":"Event count - Analysis results","description":"This is showing a statistic on the healthcheck result regarding the number of events that matched the search query and retrieved from the indexers"},"viz_jgCxlh3m":{"type":"splunk.bar","options":{"stackMode":"stacked100","legendDisplay":"bottom","legendTruncation":"ellipsisMiddle","backgroundColor":"#ffffff","seriesColorsByField":{"Success":"#A1D59C","Failed":"#FF5E5E","Healthcheck job not executed":"EEE8CE"}},"dataSources":{"primary":"ds_bC8NRbrX"},"description":"This is showing a statistic on the healthcheck result regarding the number of results returned by the savedsearch","title":"Result count - Analysis results"},"viz_FKWMMDwF":{"type":"splunk.bar","options":{"stackMode":"stacked100","legendDisplay":"bottom","legendTruncation":"ellipsisMiddle","backgroundColor":"#ffffff","seriesColorsByField":{"Success":"#A1D59C","Failed":"#FF5E5E","Healthcheck job not executed":"EEE8CE"}},"dataSources":{"primary":"ds_0T7zcJfk_ds_bC8NRbrX"},"description":"This is showing a statistic on the healthcheck result regarding the hashes calculated from the results content to evaluate if the results have been modified","title":"Result hash content - Analysis results"}},"dataSources":{"ds_mkspOX2r":{"type":"ds.search","options":{"query":"index=_audit sourcetype=audittrail action=search info!=\"granted\"","queryParameters":{"earliest":"$time.earliest$","latest":"$time.latest$"},"enableSmartSources":true},"name":"ds_audittrail_jobs"},"ds_06bIo68c":{"type":"ds.chain","options":{"extend":"ds_mkspOX2r","query":"| stats min(_time) as earliest_time, max(_time) as latest_time\n| eval earliest_time_readable = strftime(earliest_time,\"%Y-%m-%d at %H:%M:%S\"), latest_time_readable = strftime(latest_time,\"%Y-%m-%d at %H:%M:%S\")","enableSmartSources":true},"name":"ds_healthcheck_min_max_time"},"ds_d45XR29L":{"type":"ds.search","options":{"query":"``` Search 1: Get all jobs ```\r\n(index=_audit sourcetype=audittrail action=search info!=\"granted\")\r\nOR\r\n``` Search 2: Get all logs generated by the Detection Backfill app which help us to link an original job to its healthcheck one ```\r\n(`get_detection_backfill_events` type=healthcheck:job_dispatched latest=now)\r\nOR\r\n``` Search 3: Get all logs generated by the Detection Backfill app which help us to get the results content```\r\n(`get_detection_backfill_events` type=healthcheck:job_result latest=now)\r\n``` Identify all jobs ran by a savedsearch which is monitored ```\r\n| lookup detection_backfill_savedsearch_monitoring app savedsearch as savedsearch_name OUTPUT enabled as monitored_savedsearch, advanced as monitored_savedsearch_advanced\r\n``` Remove unwanted events ```\r\n| rename \"jobs.healthcheck.sid\" as sid_healthcheck, \"jobs.origin.sid\" as sid_origin, \"jobs.origin.scan_count\" as origin_scan_count, \"jobs.origin.event_count\" as origin_event_count, \"jobs.origin.result_count\" as origin_result_count, \"jobs.origin.timestamp\" as time_origin\r\n| where origin_scan_count!=\"new_scan_count\" OR isnull(origin_scan_count)\r\n| eval time_healthcheck = if(isnotnull(sid_healthcheck),_time,null())\r\n| eval search_id = if(isnotnull(search_id),replace(search_id,\"'\",\"\"),null()), search_id1 = coalesce(search_id, sid_healthcheck,sid), search_id2 = coalesce(search_id, sid_origin,sid), signature=sha1(sid_origin+sid_healthcheck)\r\n| eventstats values(signature) as signature, values(sid_healthcheck) as job_healthcheck, values(result_sha256) as results_sha256_healthcheck by search_id1\r\n| eventstats values(signature) as signature, values(sid_origin) as job_origin, values(result_sha256) as results_sha256_origin  by search_id2\r\n| eval signature = if(isnull(signature),search_id,signature), time_origin = coalesce(time_origin,_time), savedsearch = coalesce(savedsearch, savedsearch_name)\r\n| eval results_sha256_origin = if(search_id1!=search_id2,sha256(mvjoin(results_sha256_origin,\",\")),null()), results_sha256_healthcheck = if(search_id1!=search_id2,sha256(mvjoin(results_sha256_healthcheck,\",\")),null())\r\n| eval origin_scan_count = if(isnotnull(job_origin),scan_count,null()), origin_event_count = if(isnotnull(job_origin),event_count,null()), origin_result_count = if(isnotnull(job_origin),result_count,null()), new_scan_count = if(isnotnull(job_healthcheck),scan_count,null()), new_event_count = if(isnotnull(job_healthcheck),event_count,null()), new_result_count = if(isnotnull(job_healthcheck),result_count,null())\r\n| eventstats min(_time) as earliest_event_time\r\n| stats values(uid) as uid, values(earliest_event_time) as earliest_event_time, values(sourcetype) as sourcetypes, values(time_healthcheck) as time_healthcheck, min(time_origin) as time_origin, values(search_id) as search_id, values(sid_origin) as sid_origin, values(app) as app, values(savedsearch) as savedsearch, values(origin_scan_count) as origin_scan_count, values(origin_event_count) as origin_event_count, values(origin_result_count) as origin_result_count, values(sid_healthcheck) as sid_healthcheck, values(new_scan_count) as new_scan_count, values(new_event_count) as new_event_count, values(new_result_count) as new_result_count, values(monitored_savedsearch) as monitored_savedsearch, values(monitored_savedsearch_advanced) as monitored_savedsearch_advanced, values(results_sha256_origin) as results_sha256_origin, values(results_sha256_healthcheck) as results_sha256_healthcheck by signature\r\n| where match(app,\"$filter_app$\") AND match(savedsearch,\"$filter_savedsearch$\")\r\n| eval delta = time_healthcheck-time_origin,\r\n       delta_readable = if(delta>3600,tostring(round(delta/3600))+\"h \",\"\")+tostring(round((delta%3600)/60))+\"min\",\r\n       sids = if(isnotnull(sid_healthcheck),mvappend(\"Original job: \"+if(len(sid_origin)>25,substr(sid_origin,0,10)+\"(...)\"+substr(sid_origin,len(sid_origin)-15),sid_origin),\"Healthcheck job: \"+if(len(sid_healthcheck)>25,substr(sid_healthcheck,0,10)+\"(...)\"+substr(sid_healthcheck,len(sid_healthcheck)-15),sid_healthcheck),\"Healthcheck performed after \"+delta_readable),\"Original job: \"+if(len(search_id)>25,substr(search_id,0,10)+\"(...)\"+substr(search_id,len(search_id)-15),search_id)),\r\n       scan_count = case(time_origin<earliest_event_time,\"? vs \"+new_scan_count,isnotnull(new_scan_count),origin_scan_count+\" vs \"+new_scan_count,1==1,origin_scan_count+\" vs ?\")+\": \"+case(isnull(new_scan_count) OR time_origin<earliest_event_time,\"question\",origin_scan_count!=new_scan_count,\"warning\",1==1,\"ok\"),\r\n       event_count = case(time_origin<earliest_event_time,\"? vs \"+new_event_count,isnotnull(new_event_count),origin_event_count+\" vs \"+new_event_count,1==1,origin_event_count+\" vs ?\")+\": \"+case(isnull(new_event_count) OR time_origin<earliest_event_time,\"question\",origin_event_count!=new_event_count,\"warning\",1==1,\"ok\"),\r\n       result_count = case(time_origin<earliest_event_time,\"? vs \"+new_result_count,isnotnull(new_result_count),origin_result_count+\" vs \"+new_result_count,1==1,origin_result_count+\" vs ?\")+\": \"+case(isnull(new_result_count) OR time_origin<earliest_event_time,\"question\",origin_result_count!=new_result_count,\"nok\",1==1,\"ok\"),\r\n       results_hash = case(monitored_savedsearch_advanced==0,\"(Advanced monitoring disabled)\",isnotnull(results_sha256_origin),substr(results_sha256_origin,0,8)+\"(...)\"+\" vs \"+substr(results_sha256_healthcheck,0,8)+\"(...)\"+\": \"+case(results_sha256_origin!=results_sha256_healthcheck,\"nok\",1==1,\"ok\"),1==1,null()),\r\n       status = case(time_origin<earliest_event_time,\"Healthcheck job information incomplete (selected timerange isn't sufficient)\",isnotnull(sid_healthcheck) and isnotnull(scan_count),\"Found healthcheck job result\",isnotnull(sid_healthcheck),\"Healthcheck job in progress\",1==1,\"No healthcheck job found\")\r\n| where (mvcount(sids)>1 AND isnotnull(scan_count)) OR monitored_savedsearch==1 OR status==\"Healthcheck job information incomplete (selected timerange isn't sufficient)\"\r\n| table uid, time_origin, app, savedsearch, sids, status, scan_count, event_count, result_count, results_hash\r\n| sort 0 -time_origin","enableSmartSources":true,"queryParameters":{"earliest":"$time.earliest$","latest":"$time.latest$"}},"name":"ds_healthcheck_results"},"ds_EYAbil72":{"type":"ds.chain","options":{"extend":"ds_d45XR29L","enableSmartSources":true,"query":"| eval ok = \"✅\", nok = \"❌\", warning = \"⚠️\", question = \"❔\"\r\n| eval scan_count = replace(scan_count,\"ok\",ok), scan_count = replace(scan_count,\"warning\",warning), scan_count = replace(scan_count,\"question\",question), event_count = replace(event_count,\"ok\",ok), event_count = replace(event_count,\"warning\",warning), event_count = replace(event_count,\"question\",question), result_count = replace(result_count,\"nok\",nok), result_count = replace(result_count,\"ok\",ok), result_count = replace(result_count,\"question\",question), results_hash = replace(results_hash,\"nok\",nok), results_hash = replace(results_hash,\"ok\",ok), results_hash = replace(results_hash,\"question\",question)\r\n| fields - ok nok warning question\r\n| eval time_origin = strftime(time_origin,\"%Y-%m-%d %H:%M:%S (%z)\")\r\n| rename time_origin as \"Original job time\", app as App, savedsearch as Savedsearch, sids as Information, status as Status, scan_count as \"Scan count (Original vs Healthcheck)\", event_count as \"Event count (Original vs Healthcheck)\", result_count as \"Result count (Original vs Healthcheck)\", results_hash as \"Result content hash (Original vs Healthcheck)\"n, uid as UID"},"name":"ds_healthcheck_results_formatted"},"ds_zE81BpRn":{"type":"ds.chain","options":{"extend":"ds_d45XR29L","query":"| stats count by status"},"name":"ds_healthcheck_results_stats_status"},"ds_yfm30hQt":{"type":"ds.chain","options":{"enableSmartSources":true,"extend":"ds_d45XR29L","query":"| eval ok = \"✅\", nok = \"❌\", warning = \"⚠️\", question = \"❔\"\n| eval scan_count = case(match(scan_count,\"ok$\"),\"Success ok\",match(scan_count,\"warning$\"),\"Warning warning\",match(scan_count,\"question$\"),\"Healthcheck job not executed question\",1==1,scan_count)\n| eval scan_count = replace(scan_count,\"ok\",ok), scan_count = replace(scan_count,\"warning\",warning), scan_count = replace(scan_count,\"question\",question)\n| fields - ok nok warning question\n| stats count by scan_count"},"name":"ds_healthcheck_results_stats_scan"},"ds_Q8TOTrez_ds_yfm30hQt":{"type":"ds.chain","options":{"enableSmartSources":true,"extend":"ds_d45XR29L","query":"| eval ok = \"✅\", nok = \"❌\", warning = \"⚠️\", question = \"❔\"\r\n| eval event_count = case(match(event_count,\"ok$\"),\"Success ok\",match(event_count,\"warning$\"),\"Warning warning\",match(event_count,\"question$\"),\"Healthcheck job not executed question\",1==1,event_count)\r\n| eval event_count = replace(event_count,\"ok\",ok), event_count = replace(event_count,\"warning\",warning), event_count = replace(event_count,\"question\",question)\r\n| fields - ok nok warning question\r\n| stats count by event_count"},"name":"ds_healthcheck_results_stats_event"},"ds_kXMTJl8C_ds_Q8TOTrez_ds_yfm30hQt":{"type":"ds.chain","options":{"enableSmartSources":true,"extend":"ds_d45XR29L","query":"| eval ok = \"✅\", nok = \"❌\", warning = \"⚠️\", question = \"❔\"\r\n| eval result_count = case(match(result_count,\"nok$\"),\"Failed nok\",match(result_count,\"ok$\"),\"Success ok\",match(result_count,\"question$\"),\"Healthcheck job not executed question\",1==1,result_count)\r\n| eval result_count = replace(result_count,\"nok\",nok), result_count = replace(result_count,\"ok\",ok), result_count = replace(result_count,\"question\",question)\r\n| fields - ok nok warning question\r\n| stats count by result_count"},"name":"ds_healthcheck_results_stats_result"},"ds_bC8NRbrX":{"type":"ds.chain","options":{"enableSmartSources":true,"extend":"ds_d45XR29L","query":"| eval result_count = case(match(result_count,\"nok$\"),\"nok\",match(result_count,\"ok$\"),\"ok\",match(result_count,\"question$\"),\"question\",1==1,result_count)\r\n| stats count(eval(result_count==\"ok\")) as \"Success\", count(eval(result_count==\"nok\")) as \"Failed\", count(eval(result_count==\"question\")) as \"Healthcheck job not executed\", by savedsearch\r\n| where savedsearch!=\"\""},"name":"ds_healthcheck_results_chart_results_by_savedsearch"},"ds_0T7zcJfk_ds_bC8NRbrX":{"type":"ds.chain","options":{"enableSmartSources":true,"extend":"ds_d45XR29L","query":"| eval results_hash = case(match(results_hash,\"nok$\"),\"nok\",match(results_hash,\"ok$\"),\"ok\",match(results_hash,\"question$\"),\"question\",1==1,results_hash)\r\n| stats count(eval(results_hash==\"ok\")) as \"Success\", count(eval(results_hash==\"nok\")) as \"Failed\", count(eval(results_hash==\"question\")) as \"Healthcheck job not executed\", by savedsearch\r\n| where savedsearch!=\"\""},"name":"ds_healthcheck_results_chart_results_hashes_by_savedsearch"}},"defaults":{"dataSources":{"ds.search":{"options":{"queryParameters":{"latest":"$global_time.latest$","earliest":"$global_time.earliest$"}}}}},"inputs":{"input_global_trp":{"type":"input.timerange","options":{"token":"time","defaultValue":"-12h@h,now"},"title":"Time"},"input_H2jGWE9r":{"options":{"defaultValue":".*","token":"filter_app"},"title":"[Filter] App","type":"input.text"},"input_C3eiXnPi":{"options":{"defaultValue":".*","token":"filter_savedsearch"},"title":"[Filter] Savedsearch","type":"input.text"}},"layout":{"type":"grid","options":{"gutterSize":10},"structure":[{"item":"viz_ANhOREID","type":"block","position":{"x":0,"y":0,"w":1200,"h":302}},{"item":"viz_Orj3SgqP","type":"block","position":{"x":0,"y":302,"w":633,"h":315}},{"item":"viz_jgCxlh3m","type":"block","position":{"x":0,"y":617,"w":1200,"h":511}},{"item":"viz_FKWMMDwF","type":"block","position":{"x":0,"y":1128,"w":1200,"h":528}},{"item":"viz_3iNEmCMl","type":"block","position":{"x":0,"y":1656,"w":600,"h":99}},{"item":"viz_IVegbHIE","type":"block","position":{"x":0,"y":1755,"w":1200,"h":1618}},{"item":"viz_55L9hk6F","type":"block","position":{"x":600,"y":1656,"w":600,"h":99}},{"item":"viz_GSSCZghc","type":"block","position":{"x":633,"y":302,"w":567,"h":315}}],"globalInputs":["input_global_trp","input_H2jGWE9r","input_C3eiXnPi"]},"description":"This dashboard is used to track the healthcheck jobs results performed on the monitored savedsearch","title":"3. 📊 Healthcheck monitoring"}]]></definition>
            <assets><![CDATA[{}]]></assets>
        </dashboard>