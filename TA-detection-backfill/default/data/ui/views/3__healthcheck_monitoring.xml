<form version="1.1">
  <label>3. üìä Healthcheck monitoring</label>
  <description>This dashboard is used to track the healthcheck jobs results performed on the monitored savedsearch</description>
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>Time</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="text" token="filter_app">
      <label>[Filter] App</label>
      <default>.*</default>
    </input>
    <input type="text" token="filter_savedsearch">
      <label>[Filter] Savedsearch</label>
      <default>.*</default>
    </input>
    <input type="multiselect" token="filter_status">
      <label>[Filter] Status</label>
      <choice value="*">Any</choice>
      <default>*</default>
      <delimiter> </delimiter>
      <fieldForLabel>status</fieldForLabel>
      <fieldForValue>status</fieldForValue>
      <search>
        <query>| loadjob $sid_ds_healthcheck_results$
| stats count by status</query>
      </search>
    </input>
    <input type="radio" token="show_debug">
      <label>Debug</label>
      <choice value="0">No</choice>
      <choice value="1">Yes</choice>
      <change>
        <condition value="1">
          <set token="debug">1</set>
        </condition>
        <condition>
          <unset token="debug"></unset>
        </condition>
      </change>
      <default>0</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Healthcheck status on the given period</title>
      <chart>
        <title>This is showing a statistic about all the identified jobs and their relative (or not) healthcheck job status</title>
        <search>
          <query>| loadjob $sid_ds_healthcheck_results$
| stats count by status</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="charting.fieldColors">{"No healthcheck job found": "#F4BAA9","Found healthcheck job result": "#A1D59C"}</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Scan count - Analysis results</title>
      <chart>
        <title>This is showing a statistic on the healthcheck result regarding the number of events that were scanned</title>
        <search>
          <query>| loadjob $sid_ds_healthcheck_results$
| eval ok = "‚úÖ", nok = "‚ùå", warning = "‚ö†Ô∏è", question = "‚ùî"
| eval scan_count = case(match(scan_count,"ok$"),"Success ok",match(scan_count,"warning"),"Warning warning",match(scan_count,"question"),"Healthcheck job not executed question",1==1,scan_count)
| eval scan_count = replace(scan_count,"ok",ok), scan_count = replace(scan_count,"warning",warning), scan_count = replace(scan_count,"question",question)
| fields - ok nok warning question
| stats count by scan_count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="charting.fieldColors">{"Success ‚úÖ": "#A1D59C","Warning ‚ö†Ô∏è": "#FFD442","Healthcheck job not executed ‚ùî": "#F4BAA9"}</option>
      </chart>
    </panel>
    <panel>
      <title>Event count - Analysis results</title>
      <chart>
        <title>This is showing a statistic on the healthcheck result regarding the number of events that matched the search query and retrieved from the indexers</title>
        <search>
          <query>| loadjob $sid_ds_healthcheck_results$
| eval ok = "‚úÖ", nok = "‚ùå", warning = "‚ö†Ô∏è", question = "‚ùî"
| eval event_count = case(match(event_count,"ok$"),"Success ok",match(event_count,"warning"),"Warning warning",match(event_count,"question"),"Healthcheck job not executed question",1==1,event_count)
| eval event_count = replace(event_count,"ok",ok), event_count = replace(event_count,"warning",warning), event_count = replace(event_count,"question",question)
| fields - ok nok warning question
| stats count by event_count</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"Success ‚úÖ": "#A1D59C","Warning ‚ö†Ô∏è": "#FFD442","Healthcheck job not executed ‚ùî": "#F4BAA9"}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Result count - Analysis results</title>
      <chart>
        <title>This is showing a statistic on the healthcheck result regarding the number of results returned by the savedsearch</title>
        <search>
          <query>| loadjob $sid_ds_healthcheck_results$
| eval result_count = case(match(result_count,"nok$"),"nok",match(result_count,"ok"),"ok",match(result_count,"question"),"question",1==1,result_count)
| stats count(eval(result_count=="ok")) as "Success", count(eval(result_count=="nok")) as "Failed", count(eval(result_count=="question")) as "Healthcheck job not executed", by savedsearch_name
| where savedsearch_name!=""</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.stackMode">stacked100</option>
        <option name="charting.drilldown">none</option>
        <option name="height">598</option>
        <option name="refresh.display">progressbar</option>
        <option name="charting.fieldColors">{"Success": "#A1D59C","Failed": "#FF5E5E","Healthcheck job not executed": "EEE8CE"
        }</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Result hash content - Analysis results</title>
      <chart>
        <title>This is showing a statistic on the healthcheck result regarding the hashes calculated from the results content to evaluate if the results have been modified</title>
        <search>
          <query>| loadjob $sid_ds_healthcheck_results$
| eval results_hash = case(match(results_hash,"nok"),"nok",match(results_hash,"ok"),"ok",match(results_hash,"question"),"question",1==1,results_hash)
| stats count(eval(results_hash=="ok")) as "Success", count(eval(results_hash=="nok")) as "Failed", count(eval(results_hash=="question")) as "Healthcheck job not executed", by savedsearch_name
| where savedsearch_name!=""</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.stackMode">stacked100</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"Success": "#A1D59C","Failed": "#FF5E5E","Healthcheck job not executed": "EEE8CE"
        }</option>
        <option name="height">598</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Earliest job time</title>
      <single>
        <title>This is indicating the earliest job time found in the checked jobs for the given period</title>
        <search>
          <query>| loadjob $sid_ds_healthcheck_min_max_time$
| table earliest_time_readable</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="height">50</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
    <panel>
      <title>Latest job time</title>
      <single>
        <title>This is indicating the latest job time found in the checked jobs for the given period</title>
        <search>
          <query>| loadjob $sid_ds_healthcheck_min_max_time$
| table latest_time_readable</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="height">50</option>
        <option name="refresh.display">progressbar</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>Detailed executions</title>
      <table>
        <search>
          <query>| loadjob $sid_ds_healthcheck_results$
| eval ok = "‚úÖ", nok = "‚ùå", warning = "‚ö†Ô∏è", question = "‚ùî"
| eval scan_count = replace(scan_count,"ok",ok), scan_count = replace(scan_count,"warning",warning), scan_count = replace(scan_count,"question",question), event_count = replace(event_count,"ok",ok), event_count = replace(event_count,"warning",warning), event_count = replace(event_count,"question",question), result_count = replace(result_count,"nok",nok), result_count = replace(result_count,"ok",ok), result_count = replace(result_count,"question",question), results_hash = replace(results_hash,"nok",nok), results_hash = replace(results_hash,"ok",ok), results_hash = replace(results_hash,"question",question)
| fields - ok nok warning question _time
| eval time_origin = strftime(time_origin,"%Y-%m-%d %H:%M:%S (%z)")
| rename time_origin as "Original job time", app as App, savedsearch_name as Savedsearch, sids as Information, status as Status, scan_count as "Scan count (Original vs Healthcheck)", event_count as "Event count (Original vs Healthcheck)", result_count as "Result count (Original vs Healthcheck)", results_hash as "Result content hash (Original vs Healthcheck)", healthcheck_uid as "Healthcheck UID"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="count">50</option>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Status">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
        <drilldown>
          <link target="_blank">/app/TA-detection-backfill/4__results_analysis_advanced_monitoring?form.uid=$row.Healthcheck UID$</link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$debug$">
    <panel>
      <title>[Debug] ds_healthcheck_results</title>
      <table>
        <search>
          <done>
            <set token="sid_ds_healthcheck_results">$job.sid$</set>
          </done>
          <query>`get_detection_backfill_events`
| rename "job.type" as job_type, "job.sid" as job_sid, "jobs.healthcheck_sid" as healthcheck_job_sid, "job.scan_count" as scan_count, "job.event_count" as event_count, "job.result_count" as result_count
| eval time_orig = if(job_type=="orig_job",_time,null()), job_sid = coalesce(job_sid, healthcheck_job_sid)
| eval sids = if(type=="report" or type=="bind",if(job_type=="orig_job","Job (original): ","Job (healthcheck): ")+if(len(job_sid)&gt;25,substr(job_sid,0,10)+"(...)"+substr(job_sid,len(job_sid)-15),job_sid),null())
| eval origin_scan_count = if(job_type=="orig_job",scan_count,null()), new_scan_count = if(job_type=="healthcheck_job",scan_count,null())
| eval origin_event_count = if(job_type=="orig_job",event_count,null()), new_event_count = if(job_type=="healthcheck_job",event_count,null())
| eval origin_result_count = if(job_type=="orig_job",result_count,null()), new_result_count = if(job_type=="healthcheck_job",result_count,null())
| eventstats values(result_hash) as result_hash by job_sid
| eval results_hash = if(mvcount(result_hash)&gt;0,sha256(mvjoin(result_hash,",")),null()), results_sha256_origin = if(job_type=="orig_job",results_hash,null()), results_sha256_healthcheck = if(job_type=="healthcheck_job",results_hash,null())
| stats values(*) as *, list(sourcetype) as sourcetypes by healthcheck_uid
| lookup detection_backfill_savedsearch_monitoring_auto_enrichment app savedsearch AS savedsearch_name OUTPUT advanced AS detection_backfill_advanced
| eval status = case(mvcount(mvfilter(match(sourcetypes,":(?:report|bind)$")))==3,"Healthcheck done",mvcount(mvfilter(match(sourcetypes,":(?:report|bind)$")))==2 and job_type=="orig_job","Healthcheck job in progress",mvcount(mvfilter(match(sourcetypes,":(?:report|bind)$")))==1 and job_type=="orig_job","Healtcheck job scheduled",1==1,"No healthcheck job found")
| eval scan_count = case(isnotnull(new_scan_count),origin_scan_count+" vs "+new_scan_count,1==1,origin_scan_count+" vs ?")+": "+case(isnull(new_scan_count),"question",origin_scan_count!=new_scan_count,"warning",1==1,"ok"),
       event_count = case(isnotnull(new_event_count),origin_event_count+" vs "+new_event_count,1==1,origin_event_count+" vs ?")+": "+case(isnull(new_event_count),"question",origin_event_count!=new_event_count,"warning",1==1,"ok"),
       result_count = case(isnotnull(new_result_count),origin_result_count+" vs "+new_result_count,1==1,origin_result_count+" vs ?")+": "+case(isnull(new_result_count),"question",origin_result_count!=new_result_count,"nok",1==1,"ok"),
       results_hash = case(detection_backfill_advanced==0,"(Advanced monitoring disabled)",new_scan_count==0,"No event scanned",isnotnull(results_sha256_origin) AND isnotnull(results_sha256_healthcheck),substr(results_sha256_origin,0,8)+"(...)"+" vs "+substr(results_sha256_healthcheck,0,8)+"(...)"+": "+case(results_sha256_origin!=results_sha256_healthcheck,"nok",1==1,"ok"),isnull(results_sha256_origin),"All results data aren't available (not yet executed or out of timerange: original job results are missing)",isnull(results_sha256_healthcheck),"All results data aren't available (not yet executed or out of timerange: healthcheck job results are missing)",1==1,"Unknown status for results hashes")
| rename time_orig as _time
| sort 0 -_time
| table _time, healthcheck_uid, app, savedsearch_name, sids, status, scan_count, event_count, result_count, results_hash</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row depends="$debug$">
    <panel>
      <title>[Debug] ds_healthcheck_min_max_time</title>
      <table>
        <search>
          <done>
            <set token="sid_ds_healthcheck_min_max_time">$job.sid$</set>
          </done>
          <query>| loadjob $sid_ds_healthcheck_results$
| stats min(_time) as earliest_time, max(_time) as latest_time
| eval earliest_time_readable = strftime(earliest_time,"%Y-%m-%d at %H:%M:%S"), latest_time_readable = strftime(latest_time,"%Y-%m-%d at %H:%M:%S")</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>